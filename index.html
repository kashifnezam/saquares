<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Squares Trainer ‚Äî Engaging</title>
<style>
  :root{
    --bg: linear-gradient(135deg,#eef2ff,#fff0f6);
    --card:#ffffff;
    --accent:#7c3aed;
    --accent-2:#06b6d4;
    --muted:#6b7280;
    --good:#16a34a;
    --bad:#ef4444;
    --glass: rgba(255,255,255,0.7);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg);color:#07203a;display:flex;flex-direction:column;align-items:center;padding:12px;}
  header{width:100%;max-width:980px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:1.15rem;letter-spacing:0.2px}
  .controls{display:flex;gap:8px;align-items:center}
  button.btn{
    appearance:none;border:0;padding:10px 14px;border-radius:12px;background:linear-gradient(90deg,var(--accent),#4f46e5);color:white;font-weight:700;
    box-shadow:0 10px 25px rgba(99,102,241,0.12);font-size:14px;touch-action:manipulation;
  }
  button.ghost{background:transparent;color:#07203a;border:1px solid rgba(7,32,58,0.06);box-shadow:none}
  main{width:100%;max-width:980px;margin-top:12px;flex:1;display:flex;flex-direction:column;gap:10px;}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .modes{display:flex;gap:6px;flex-wrap:wrap}
  .panel{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 18px 40px rgba(2,6,23,0.06)}
  .study-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
  @media(min-width:560px){.study-grid{grid-template-columns:repeat(6,1fr)}}
  .card{background:linear-gradient(180deg,#fff,#fbfbff);border-radius:12px;padding:12px;text-align:center;box-shadow:0 12px 30px rgba(2,6,23,0.06);transition:transform 160ms,box-shadow 160ms}
  .card:active{transform:translateY(4px) scale(0.995)}
  .num{font-size:20px;font-weight:800;color:var(--accent)}
  .sq{font-size:14px;color:#7c3aed;margin-top:6px}
  /* Quiz UI */
  .question{font-size:22px;font-weight:800;margin-bottom:6px}
  .answer-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="number"]{width:130px;padding:12px;border-radius:10px;border:1px solid #c7d2fe;font-size:18px;text-align:center}
  .feedback{min-height:28px;margin-top:8px;font-weight:800}
  .score{font-size:13px;color:var(--muted);margin-top:8px}
  .hintBox{margin-top:10px;padding:10px;border-radius:10px;background:rgba(10,10,10,0.03);font-size:14px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .small{font-size:13px;color:var(--muted)}
  /* Timer ring */
  .timerWrap{position:relative;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center}
  svg.timer{transform:rotate(-90deg)}
  .timeNum{position:absolute;font-weight:800;font-size:12px}
  /* Confetti layer */
  #confettiCanvas{position:fixed;left:0;top:0;pointer-events:none;z-index:9999;width:100%;height:100%;}
  /* badges */
  .badge{
    position:fixed;right:14px;bottom:18px;background:linear-gradient(90deg,#10b981,#06b6d4);padding:10px 12px;border-radius:14px;color:white;font-weight:800;box-shadow:0 10px 30px rgba(6,182,212,0.12);
  }
  .centerModal{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:10000;min-width:280px;max-width:90%;
  }
  .popup{background:linear-gradient(180deg,#fff,#f8fafc);border-radius:14px;padding:14px;box-shadow:0 30px 60px rgba(2,6,23,0.15);text-align:center}
  .leaderboard{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
  .leaderboard .row{display:flex;justify-content:space-between;width:100%}
  /* responsive lower controls */
  footer{width:100%;max-width:980px;padding:6px 0;text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>

<header>
  <h1>Squares Trainer ‚Äî Fun Mode</h1>
  <div class="controls">
    <button id="openLeaderboard" class="ghost">üèÜ Leaderboard</button>
    <button id="resetBtn" class="ghost">Reset</button>
    <button id="toggleStudy" class="ghost">Study</button>
  </div>
</header>

<main>
  <div class="topbar">
    <div class="modes">
      <select id="levelSelect" class="ghost" style="padding:10px;border-radius:10px;">
        <option value="easy">Easy (2‚Äì20)</option>
        <option value="medium">Medium (2‚Äì35)</option>
        <option value="hard" selected>Hard (2‚Äì50)</option>
      </select>
      <button id="startRound" class="btn">Start Round</button>
      <button id="mcqMode" class="btn">MCQ</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="small">Streak: <span id="streak">0</span></div>
      <div class="small">Combo: x<span id="combo">1</span></div>
    </div>
  </div>

  <!-- Study panel -->
  <section id="studyPanel" class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div class="small">Study Mode ‚Äî swipe a card to reveal square</div>
      <div><button id="shuffleStudy" class="ghost">Shuffle</button></div>
    </div>
    <div id="studyGrid" class="study-grid" style="margin-top:10px"></div>
  </section>

  <!-- Quiz panel -->
  <section id="quizPanel" class="panel" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="question" id="questionText">What is 2¬≤ ?</div>
        <div class="small" id="roundInfo">Round: 1 / 10</div>
      </div>
      <div class="timerWrap">
        <svg class="timer" width="48" height="48"><circle cx="24" cy="24" r="18" stroke="#e6e9ff" stroke-width="8" fill="none"></circle><circle id="timerCircle" cx="24" cy="24" r="18" stroke="#7c3aed" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="113.097" stroke-dashoffset="0"></circle></svg>
        <div class="timeNum" id="timeNum">18</div>
      </div>
    </div>

    <div class="answer-row" style="margin-top:12px">
      <input id="answerField" type="number" placeholder="Answer">
      <button id="submitAnswer" class="btn">Submit</button>
      <button id="hintBtn" class="ghost">üí° Hint</button>
      <button id="stepsBtn" class="ghost">üßæ Steps</button>
    </div>

    <div class="feedback" id="feedback"></div>
    <div class="score" id="scoreLine">Score: 0</div>
    <div class="hintBox" id="hintBox">Hints will appear here.</div>
  </section>

  <!-- MCQ panel -->
  <section id="mcqPanel" class="panel" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="question" id="mcqQ">What is 2¬≤ ?</div><div class="small" id="mcqRound">Round 1/10</div></div>
      <div class="small">Streak: <span id="mcqStreak">0</span></div>
    </div>
    <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
      <button class="card" id="optA"></button>
      <button class="card" id="optB"></button>
      <button class="card" id="optC"></button>
      <button class="card" id="optD"></button>
    </div>
    <div class="feedback" id="mcqFeedback"></div>
    <div class="score" id="mcqScore">Score: 0</div>
    <div class="hintBox" id="mcqHint">MCQ hints appear here.</div>
  </section>
</main>

<footer>Tip: Try to keep streaks to earn badges. Add to home screen for a quick practice routine!</footer>

<!-- Confetti canvas -->
<canvas id="confettiCanvas"></canvas>

<!-- Achievement / leaderboard modal area -->
<div id="modalArea"></div>

<script>
/* ---------- Data & helpers ---------- */
const LEVELS = {easy: {max:20}, medium: {max:35}, hard: {max:50}};
let level = 'hard';
let pool = []; // numbers
const LS_KEY = 'squares_engage_v1';
let state = loadState() || {best:[], leaderboard: [], badges: {}, roundsPlayed: 0};
let round = {index:0,total:10,mode:'quiz',score:0,streak:0,combo:1};
let currentNumber = null;
let quizTimer = null;
let timerSecs = 18;
let timerRemaining = timerSecs;
let audioCtx = null;

/* --------- Audio beep and success sounds (WebAudio) --------- */
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function soundBeep(f=880,d=0.07,vol=0.06){
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sine'; o.frequency.value = f;
  g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); setTimeout(()=>o.stop(), d*1000);
}
function soundCorrect(){
  soundBeep(880,0.07,0.08); setTimeout(()=>soundBeep(1320,0.06,0.06),90);
}
function soundWrong(){ soundBeep(220,0.06,0.08); setTimeout(()=>soundBeep(160,0.06,0.06),90); }

/* ---------- Confetti (simple particle burst) ---------- */
const confettiCanvas = document.getElementById('confettiCanvas');
const confettiCtx = confettiCanvas.getContext('2d');
let confettiParticles = [];
function resizeConfetti(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
window.addEventListener('resize', resizeConfetti); resizeConfetti();

function spawnConfetti(x,y,amount=30){
  for(let i=0;i<amount;i++){
    confettiParticles.push({
      x: x || (innerWidth/2) + (Math.random()-0.5)*200,
      y: y || (innerHeight/2) + (Math.random()-0.5)*50,
      vx: (Math.random()-0.5)*8,
      vy: Math.random()*-8 - 2,
      r: Math.random()*6 + 4,
      color: `hsl(${Math.floor(Math.random()*360)} 90% 60%)`,
      life: Math.random()*80 + 40
    });
  }
}
function confettiLoop(){
  confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  for(let i=confettiParticles.length-1;i>=0;i--){
    const p = confettiParticles[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.4; p.life--;
    confettiCtx.fillStyle = p.color;
    confettiCtx.beginPath();
    confettiCtx.ellipse(p.x,p.y,p.r,p.r*0.7,Math.random()*Math.PI*2,0,Math.PI*2);
    confettiCtx.fill();
    if(p.y > confettiCanvas.height + 50 || p.life <= 0) confettiParticles.splice(i,1);
  }
  requestAnimationFrame(confettiLoop);
}
confettiLoop();

/* ---------- Utility ---------- */
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadState(){ try{return JSON.parse(localStorage.getItem(LS_KEY));}catch(e){return null;} }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ---------- UI refs ---------- */
const studyGrid = document.getElementById('studyGrid');
const studyPanel = document.getElementById('studyPanel');
const quizPanel = document.getElementById('quizPanel');
const mcqPanel = document.getElementById('mcqPanel');
const questionText = document.getElementById('questionText');
const answerField = document.getElementById('answerField');
const submitAnswer = document.getElementById('submitAnswer');
const hintBtn = document.getElementById('hintBtn');
const stepsBtn = document.getElementById('stepsBtn');
const hintBox = document.getElementById('hintBox');
const feedback = document.getElementById('feedback');
const scoreLine = document.getElementById('scoreLine');
const streakEl = document.getElementById('streak');
const comboEl = document.getElementById('combo');
const timerCircle = document.getElementById('timerCircle');
const timeNum = document.getElementById('timeNum');

const levelSelect = document.getElementById('levelSelect');
const startRoundBtn = document.getElementById('startRound');
const mcqModeBtn = document.getElementById('mcqMode');
const shuffleStudyBtn = document.getElementById('shuffleStudy');
const toggleStudy = document.getElementById('toggleStudy');
const resetBtn = document.getElementById('resetBtn');
const openLeaderboard = document.getElementById('openLeaderboard');
const modalArea = document.getElementById('modalArea');

/* MCQ refs */
const mcqQ = document.getElementById('mcqQ');
const optA = document.getElementById('optA');
const optB = document.getElementById('optB');
const optC = document.getElementById('optC');
const optD = document.getElementById('optD');
const mcqFeedback = document.getElementById('mcqFeedback');
const mcqScore = document.getElementById('mcqScore');
const mcqHint = document.getElementById('mcqHint');
const mcqStreak = document.getElementById('mcqStreak');

/* ---------- Build study grid ---------- */
function buildPool(){
  const max = LEVELS[level].max;
  pool = Array.from({length: max-1}, (_,i)=>i+2);
}
function buildStudyGrid(){
  studyGrid.innerHTML = '';
  pool.forEach(n=>{
    const c = document.createElement('div');
    c.className = 'card';
    c.innerHTML = `<div class="num">${n}</div><div class="sq" data-hidden>${'‚óè‚óè‚óè'}</div>`;
    // touch to toggle reveal
    c.addEventListener('click', ()=> {
      const sq = c.querySelector('.sq');
      if(sq.dataset.hidden !== undefined){
        sq.dataset.hidden = false;
        sq.innerText = n*n;
        c.animate([{transform:'scale(1.03)'},{transform:'scale(1)'}],{duration:160});
      } else {
        // hide again
        delete sq.dataset.hidden;
        sq.innerText = '‚óè‚óè‚óè';
      }
    });
    // swipe to reveal: touchstart / touchend trick (simple)
    studyGrid.appendChild(c);
  });
}
levelSelect.onchange = () => { level=levelSelect.value; buildPool(); buildStudyGrid(); };
shuffleStudyBtn.onclick = ()=>{ shuffle(pool); buildStudyGrid(); };

/* ---------- Round / quiz control ---------- */
function startRound(mode='quiz', total=10){
  buildPool();
  round = {index:0,total:total,mode:mode,score:0,streak:0,combo:1,earnedBadges:[]};
  state.roundsPlayed = (state.roundsPlayed||0) + 1;
  saveState();
  if(mode==='quiz') openQuizUI();
  if(mode==='mcq') openMCQUI();
}
startRoundBtn.onclick = ()=> startRound('quiz', 10);
mcqModeBtn.onclick = ()=> startRound('mcq',10);

function openQuizUI(){
  studyPanel.style.display='none';
  mcqPanel.style.display='none';
  quizPanel.style.display='block';
  nextQuestion();
}
function openMCQUI(){
  studyPanel.style.display='none';
  quizPanel.style.display='none';
  mcqPanel.style.display='block';
  nextMCQ();
}

/* --------- Timer visuals --------- */
function startTimer(seconds=18){
  stopTimer();
  timerRemaining = seconds;
  const circumference = 2*Math.PI*18;
  timerCircle.style.strokeDasharray = circumference;
  timerCircle.style.strokeDashoffset = 0;
  timeNum.innerText = timerRemaining;
  quizTimer = setInterval(()=>{
    timerRemaining--;
    timeNum.innerText = timerRemaining;
    const pct = (timerRemaining/seconds);
    timerCircle.style.strokeDashoffset = circumference*(1-pct);
    if(timerRemaining <= 0){
      clearInterval(quizTimer);
      timerCircle.style.strokeDashoffset = circumference;
      timeUp();
    }
  },1000);
}
function stopTimer(){ if(quizTimer) clearInterval(quizTimer); quizTimer=null; }

/* ---------- Next question / answer checks ---------- */
function nextQuestion(){
  if(round.index >= round.total){ endRound(); return; }
  round.index++;
  currentNumber = rand(pool);
  questionText.innerText = `What is ${currentNumber}¬≤ ?`;
  answerField.value = '';
  feedback.innerText = '';
  hintBox.innerText = 'Tip: Tap üí° for a smart, non-spoiler hint.';
  scoreLine.innerText = `Score: ${round.score}`;
  streakEl.innerText = round.streak;
  comboEl.innerText = round.combo;
  startTimer(timerSecs);
  answerField.focus();
}
function checkAnswer(){
  const user = Number(answerField.value);
  const correct = currentNumber*currentNumber;
  round.totalAsked = (round.totalAsked||0)+1;
  stopTimer();
  if(user === correct){
    // correct
    round.score += 10 * round.combo;
    round.streak++;
    round.combo = Math.min(5, Math.floor(round.streak/3)+1); // increase combo every 3 streak
    feedback.style.color = 'var(--good)';
    feedback.innerText = '‚úì Correct!';
    soundCorrect(); spawnConfetti(innerWidth/2, innerHeight/3, 40);
    checkBadges('correct');
  } else {
    feedback.style.color = 'var(--bad)';
    feedback.innerText = `‚úó Wrong ‚Äî ${correct}`;
    round.streak = 0;
    round.combo = 1;
    soundWrong();
  }
  scoreLine.innerText = `Score: ${round.score}`;
  streakEl.innerText = round.streak;
  comboEl.innerText = round.combo;
  saveProgressSnapshot();
  setTimeout(nextQuestion, 900);
}
submitAnswer.onclick = ()=>{ ensureAudio(); checkAnswer(); }
answerField.addEventListener('keypress', e=>{ if(e.key==='Enter') { ensureAudio(); checkAnswer(); } });

/* timer up auto-wrong */
function timeUp(){
  feedback.style.color = 'var(--muted)';
  feedback.innerText = '‚è±Ô∏è Time up!';
  round.streak = 0; round.combo = 1;
  scoreLine.innerText = `Score: ${round.score}`;
  soundWrong();
  setTimeout(nextQuestion, 900);
}

/* ---------- Hints & Steps ---------- */
function contextHint(n){
  const s=String(n);
  if(s.endsWith('5')) return `Ends with 5 ‚Üí Use: (a√ó(a+1)) then append 25. Example: 45¬≤ ‚Üí 4√ó5 =20 ‚Üí 2025.`;
  if(Math.abs(n-50)<=5) {
    const d = n-50; return `Near 50 ‚Üí 50¬≤=2500; n¬≤ = 2500 + ${d*100} + ${d*d}. For ${n} that is ${2500 + d*100 + d*d}.`;
  }
  if(Math.abs(n-100)<=5) {
    const d = 100-n; return `Near 100 ‚Üí n¬≤ = 10000 - 200√ó${d} + ${d*d}.`;
  }
  const last = n%10; const endings = {0:'00',1:'1',2:'4',3:'9',4:'6',5:'25',6:'36',7:'49',8:'64',9:'81'};
  return `Last-digit trick: since it ends with ${last}, square ends with ${endings[last]}.`;
}
hintBtn.onclick = ()=>{ if(currentNumber) hintBox.innerText = 'Hint: ' + contextHint(currentNumber); else hintBox.innerText = 'Hint: Try a round first!'; }
stepsBtn.onclick = ()=>{ if(currentNumber) hintBox.innerText = 'Steps: ' + stepExplanation(currentNumber); else hintBox.innerText = 'Start a round to see steps.'; }

function stepExplanation(n){
  if(String(n).endsWith('5')){ const a=Math.floor(n/10); return `${n}¬≤ => ${a}√ó${a+1} = ${a*(a+1)} then append 25 -> ${a*(a+1)}25`; }
  if(Math.abs(n-50)<=5){ const d=n-50; return `${n}¬≤ => 2500 + ${d*100} + ${d*d} = ${2500 + d*100 + d*d}`; }
  if(n<30){ const t=Math.floor(n/10)*10, u=n%10; return `(${t}+${u})¬≤ = ${t*t} + 2√ó${t}√ó${u} + ${u*u} = ${t*t + 2*t*u + u*u}`; }
  return `(n-1)(n+1)+1: ${n}¬≤ = ${n-1}√ó${n+1} + 1 = ${(n-1)*(n+1)} + 1 = ${(n-1)*(n+1)+1}`;
}

/* ---------- Badges & achievements ---------- */
function checkBadges(event){
  // simple badges
  if(event==='correct' && !state.badges['first']){ awardBadge('First Correct', 'first'); }
  if(round.streak===5 && !state.badges['5']) awardBadge('5-in-a-row!', '5');
  if(round.streak===10 && !state.badges['10']) awardBadge('10-in-a-row!', '10');
}
function awardBadge(title,key){
  state.badges[key]=true; saveState();
  // popup
  const box = document.createElement('div'); box.className='centerModal';
  box.innerHTML = `<div class="popup"><div style="font-size:18px;font-weight:900">üèÖ ${title}</div><div style="margin-top:8px;color:var(--muted)">Badge added to your profile</div><div style="margin-top:12px"><button class="btn" id="closeBadge">Nice!</button></div></div>`;
  modalArea.appendChild(box);
  document.getElementById('closeBadge').onclick = ()=> modalArea.innerHTML='';
}

/* ---------- End round & summary ---------- */
function endRound(){
  stopTimer();
  // push score to leaderboard
  const entry = {score: round.score, date: new Date().toISOString()};
  state.leaderboard = state.leaderboard || [];
  state.leaderboard.push(entry);
  // keep top 10 by score desc
  state.leaderboard.sort((a,b)=>b.score-a.score);
  if(state.leaderboard.length>10) state.leaderboard.length=10;
  saveState();
  // show summary
  showSummary(entry);
}
function showSummary(entry){
  const modal = document.createElement('div'); modal.className='centerModal';
  modal.innerHTML = `<div class="popup">
    <div style="font-size:20px;font-weight:900">Round Complete üéâ</div>
    <div style="margin-top:8px">Score: <b>${round.score}</b></div>
    <div style="margin-top:8px">Max Streak: <b>${round.streak}</b></div>
    <div style="margin-top:10px">${round.earnedBadges && round.earnedBadges.length ? 'Badges: ' + round.earnedBadges.join(', ') : ''}</div>
    <div style="margin-top:12px"><button class="btn" id="saveNameBtn">Save to Leaderboard</button> <button class="ghost" id="playAgain">Play Again</button></div>
    <div style="margin-top:10px" class="small">You can also view the leaderboard to compare.</div>
  </div>`;
  modalArea.appendChild(modal);
  document.getElementById('playAgain').onclick = ()=> { modalArea.innerHTML=''; startRound(round.mode, round.total); };
  document.getElementById('saveNameBtn').onclick = ()=> {
    const name = prompt('Enter name for leaderboard (or leave blank)');
    if(name!==null){
      entry.name = name || 'You';
      saveState();
      modalArea.innerHTML='';
      showLeaderboard();
    }
  };
}

/* ---------- Leaderboard ---------- */
function showLeaderboard(){
  const modal = document.createElement('div'); modal.className='centerModal';
  modal.innerHTML = `<div class="popup">
    <div style="font-size:20px;font-weight:900">üèÜ Leaderboard</div>
    <div style="margin-top:10px" class="leaderboard">${(state.leaderboard||[]).map((e,i)=>`<div class="row"><div>#${i+1} ${e.name||'Player'}</div><div><b>${e.score}</b></div></div>`).join('')}</div>
    <div style="margin-top:12px"><button class="btn" id="closeLB">Close</button></div>
  </div>`;
  modalArea.appendChild(modal);
  document.getElementById('closeLB').onclick = ()=> modalArea.innerHTML='';
}
openLeaderboard.onclick = showLeaderboard;

/* ---------- MCQ mode ---------- */
let mcqCurrent = null;
let mcqRoundCount = 0;
let mcqScoreVal = 0;
let mcqStreakVal = 0;
function nextMCQ(){
  if(mcqRoundCount >= 10){ endMCQRound(); return; }
  mcqRoundCount++;
  mcqCurrent = rand(pool);
  mcqQ.innerText = `What is ${mcqCurrent}¬≤ ?`;
  const correct = mcqCurrent*mcqCurrent;
  let opts = new Set([correct]);
  while(opts.size < 4){
    const delta = (Math.floor(Math.random()*9)-4) * (Math.floor(Math.random()*7)+1);
    opts.add(Math.max(1, correct + delta));
  }
  const arr = Array.from(opts).sort(()=>Math.random()-0.5);
  [optA,optB,optC,optD].forEach((el,i)=>{ el.innerText = arr[i]; el.onclick = ()=> checkMCQ(arr[i]); });
  mcqFeedback.innerText = '';
  mcqScore.innerText = `Score: ${mcqScoreVal}`;
  mcqHint.innerText = 'Tip: Tap hint for a quick trick.';
}
function checkMCQ(val){
  const correct = mcqCurrent*mcqCurrent;
  if(val === correct){
    mcqScoreVal += 10;
    mcqStreakVal++;
    soundCorrect(); spawnConfetti(innerWidth/2, innerHeight/3, 30);
    mcqFeedback.style.color = 'var(--good)';
    mcqFeedback.innerText = '‚úì Correct';
    checkBadges('correct');
  } else {
    soundWrong();
    mcqStreakVal = 0;
    mcqFeedback.style.color = 'var(--bad)';
    mcqFeedback.innerText = `‚úó Wrong ‚Äî ${correct}`;
  }
  mcqScore.innerText = `Score: ${mcqScoreVal}`;
  mcqStreak.innerText = mcqStreakVal;
  setTimeout(nextMCQ, 900);
}
function endMCQRound(){
  // push to leaderboard
  state.leaderboard.push({score: mcqScoreVal, date: new Date().toISOString(), name: 'MCQ Player'});
  state.leaderboard.sort((a,b)=>b.score-a.score);
  if(state.leaderboard.length>10) state.leaderboard.length=10;
  saveState();
  // show summary modal
  const modal = document.createElement('div'); modal.className='centerModal';
  modal.innerHTML = `<div class="popup"><div style="font-size:20px;font-weight:900">MCQ Round Done</div><div style="margin-top:8px">Score: ${mcqScoreVal}</div><div style="margin-top:12px"><button class="btn" id="closeMCQ">Close</button></div></div>`;
  modalArea.appendChild(modal);
  document.getElementById('closeMCQ').onclick = ()=> modalArea.innerHTML='';
}

/* ---------- Progress save ---------- */
function saveProgressSnapshot(){
  state.lastScore = round.score;
  state.lastTimestamp = new Date().toISOString();
  saveState();
}

/* ---------- Init ---------- */
function init(){
  buildPool();
  buildStudyGrid();
  levelSelect.value = level;
  // toggle study button
  toggleStudy.onclick = ()=> { studyPanel.style.display = studyPanel.style.display === 'none' ? 'block' : 'none' };
  resetBtn.onclick = ()=> { if(confirm('Reset all progress & badges?')){ localStorage.removeItem(LS_KEY); state = {leaderboard:[],badges:{}}; saveState(); alert('Reset done'); } };
  document.getElementById('toggleStudy').onclick = ()=> { studyPanel.style.display = studyPanel.style.display === 'none' ? 'block' : 'none'; };
}
init();

/* ---------- small UX touches: reveal confetti if first-run ---------- */
if(!state.seenWelcome){
  state.seenWelcome = true;
  saveState();
  setTimeout(()=>{ spawnConfetti(innerWidth/2, innerHeight/3, 60); }, 700);
}
</script>

</body>
</html>
